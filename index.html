<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crear Draft Issues en Project (GitHub Projects v2)</title>
<style>
  :root{
    --bg-primary:#0a0e1a;
    --bg-secondary:#0f1419;
    --bg-card:#161b22;
    --bg-card-hover:#1c2128;
    --border:#30363d;
    --border-subtle:#21262d;
    --accent:#2ea043;
    --accent-hover:#3fb950;
    --accent-muted:rgba(46,160,67,0.15);
    --text-primary:#e6edf3;
    --text-secondary:#8b949e;
    --text-muted:#6e7681;
    --success:#3fb950;
    --error:#f85149;
    --warning:#d29922;
    --shadow:rgba(1,4,9,0.85);
  }
  
  *{
    box-sizing:border-box;
    margin:0;
    padding:0;
  }
  
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans',Helvetica,Arial,sans-serif;
    background:linear-gradient(135deg,var(--bg-primary) 0%,var(--bg-secondary) 100%);
    color:var(--text-primary);
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    line-height:1.5;
  }
  
  .container{
    width:100%;
    max-width:1200px;
    background:var(--bg-card);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 16px 32px var(--shadow);
    padding:24px;
  }
  
  @media (min-width:768px){
    .container{
      padding:32px;
    }
  }
  
  header{
    margin-bottom:24px;
    padding-bottom:20px;
    border-bottom:1px solid var(--border-subtle);
  }
  
  h1{
    font-size:20px;
    font-weight:600;
    margin-bottom:8px;
    color:var(--text-primary);
  }
  
  @media (min-width:768px){
    h1{
      font-size:24px;
    }
  }
  
  .subtitle{
    font-size:13px;
    color:var(--text-secondary);
    line-height:1.6;
  }
  
  .subtitle code{
    background:var(--bg-secondary);
    padding:2px 6px;
    border-radius:4px;
    font-size:12px;
    color:var(--accent);
    font-family:'SF Mono',Monaco,Consolas,monospace;
  }
  
  .form-section{
    margin-bottom:20px;
  }
  
  .row{
    display:grid;
    gap:16px;
    grid-template-columns:1fr;
  }
  
  @media (min-width:768px){
    .row{
      grid-template-columns:1fr 280px;
    }
    .row.split{
      grid-template-columns:1fr 1fr;
    }
  }
  
  .form-group{
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  
  label{
    font-size:13px;
    font-weight:600;
    color:var(--text-primary);
    display:block;
  }
  
  input[type=text],
  input[type=password],
  textarea,
  select{
    width:100%;
    padding:10px 12px;
    border-radius:6px;
    border:1px solid var(--border);
    background:var(--bg-secondary);
    color:var(--text-primary);
    font-size:14px;
    transition:all 0.2s ease;
    font-family:inherit;
  }
  
  input:focus,
  textarea:focus,
  select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 3px var(--accent-muted);
  }
  
  input:hover,
  textarea:hover,
  select:hover{
    border-color:#484f58;
  }
  
  textarea{
    min-height:120px;
    resize:vertical;
    font-family:'SF Mono',Monaco,Consolas,monospace;
    font-size:13px;
    line-height:1.6;
  }
  
  .hint{
    font-size:12px;
    color:var(--text-muted);
    line-height:1.5;
  }
  
  .controls{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:24px;
    padding-top:20px;
    border-top:1px solid var(--border-subtle);
  }
  
  button{
    padding:10px 16px;
    border-radius:6px;
    border:1px solid transparent;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    transition:all 0.2s ease;
    font-family:inherit;
    white-space:nowrap;
  }
  
  button:active{
    transform:translateY(1px);
  }
  
  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  
  button.primary{
    background:var(--accent);
    color:#ffffff;
    border-color:var(--accent);
  }
  
  button.primary:hover:not(:disabled){
    background:var(--accent-hover);
    border-color:var(--accent-hover);
  }
  
  button.secondary{
    background:transparent;
    border-color:var(--border);
    color:var(--text-secondary);
  }
  
  button.secondary:hover:not(:disabled){
    border-color:#484f58;
    background:var(--bg-card-hover);
    color:var(--text-primary);
  }
  
  .output{
    margin-top:24px;
    padding:16px;
    border-radius:8px;
    background:var(--bg-secondary);
    border:1px solid var(--border);
    max-height:400px;
    overflow:auto;
    font-size:13px;
  }
  
  .output:empty{
    display:none;
  }
  
  .line{
    padding:12px;
    border-radius:6px;
    margin-bottom:8px;
    background:var(--bg-card);
    border:1px solid var(--border-subtle);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  
  .line:last-child{
    margin-bottom:0;
  }
  
  .ok{
    color:var(--success);
    font-weight:600;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .err{
    color:var(--error);
    font-weight:600;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  pre{
    white-space:pre-wrap;
    word-break:break-word;
    margin:0;
    font-family:'SF Mono',Monaco,Consolas,monospace;
    font-size:12px;
    line-height:1.6;
    color:var(--text-secondary);
  }
  
  .projects-list{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-top:16px;
  }
  
  .projects-list:empty{
    display:none;
  }
  
  .project-item{
    padding:16px;
    border-radius:8px;
    background:var(--bg-secondary);
    border:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:12px;
    transition:all 0.2s ease;
  }
  
  @media (min-width:768px){
    .project-item{
      flex-direction:row;
      justify-content:space-between;
      align-items:center;
    }
  }
  
  .project-item:hover{
    background:var(--bg-card-hover);
    border-color:#484f58;
  }
  
  .project-meta{
    flex:1;
  }
  
  .project-meta strong{
    font-size:14px;
    color:var(--text-primary);
    display:block;
    margin-bottom:6px;
  }
  
  .project-meta-details{
    font-size:12px;
    color:var(--text-muted);
    word-break:break-all;
  }
  
  .project-actions{
    display:flex;
    gap:8px;
    flex-shrink:0;
  }
  
  .project-item button{
    padding:8px 14px;
    font-size:13px;
  }
  
  .small-note{
    font-size:12px;
    color:var(--text-muted);
    margin-top:12px;
    padding:12px;
    background:var(--accent-muted);
    border-radius:6px;
    border:1px solid rgba(46,160,67,0.3);
  }
  
  .small-note:empty{
    display:none;
  }
  
  footer{
    margin-top:24px;
    padding-top:20px;
    border-top:1px solid var(--border-subtle);
    color:var(--text-muted);
    font-size:12px;
    text-align:center;
  }
  
  @media (min-width:768px){
    footer{
      text-align:right;
    }
  }
  
  /* Custom scrollbar */
  ::-webkit-scrollbar{
    width:10px;
    height:10px;
  }
  
  ::-webkit-scrollbar-track{
    background:var(--bg-secondary);
  }
  
  ::-webkit-scrollbar-thumb{
    background:var(--border);
    border-radius:5px;
  }
  
  ::-webkit-scrollbar-thumb:hover{
    background:#484f58;
  }
</style>
</head>
<body>
  <div class="container" role="main">
    <header>
      <h1>Crear draft issues en GitHub Project (v2)</h1>
      <p class="subtitle">Introduce tu token (Fine-grained o classic con scopes <code>repo</code> y <code>project</code>), el ID del Project (p.ej. <code>PVT_xxx</code>) y crea items en el backlog.</p>
    </header>

    <div class="form-section">
      <div class="row">
        <div class="form-group">
          <label for="token">GitHub Token (PAT)</label>
          <input id="token" type="password" placeholder="ghp_..." />
          <div class="hint">No compartas el token. El token debe permitir acceso a Projects (y repo si usas otras acciones).</div>
        </div>
        <div class="form-group">
          <label for="projectId">Project v2 ID</label>
          <input id="projectId" type="text" placeholder="PVT_xxx" />
          <div class="hint">Puedes obtenerlo listando tus Projects desde el botón "Listar mis Projects (test)".</div>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="form-group">
        <label for="lines">Lista de draft issues (una por línea)</label>
        <textarea id="lines" placeholder="Título | descripción (opcional)"></textarea>
      </div>
    </div>

    <div class="form-section">
      <div class="row split">
        <div class="form-group">
          <label for="jsonInput">O JSON (array de objetos con: title, body)</label>
          <textarea id="jsonInput" placeholder='[{"title":"T1","body":"desc"}]'></textarea>
        </div>
        <div class="form-group">
          <label for="mode">Opciones</label>
          <select id="mode">
            <option value="draft">Crear draft issue en Project (addProjectV2DraftIssue)</option>
            <option value="create_and_add">Crear issue en repo y añadir al Project (REST + GraphQL)</option>
          </select>
          <div class="hint">Si eliges crear issue en repo necesitarás owner/repo abajo.</div>
        </div>
      </div>
    </div>

    <div class="form-section" id="repoRow" style="display:none">
      <div class="row split">
        <div class="form-group">
          <label for="owner">Owner</label>
          <input id="owner" type="text" placeholder="tu-user-o-org" />
        </div>
        <div class="form-group">
          <label for="repo">Repo</label>
          <input id="repo" type="text" placeholder="MiRepo" />
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="createFromLines" class="primary">Crear desde líneas</button>
      <button id="createFromJson" class="secondary">Crear desde JSON</button>
      <button id="clearOutput" class="secondary">Limpiar</button>
      <button id="testToken" class="secondary">Listar mis Projects (test)</button>
    </div>

    <div id="output" class="output" aria-live="polite"></div>
    <div id="projectsContainer" class="projects-list" aria-live="polite"></div>
    <div class="small-note">Haz clic en "Usar" para copiar el <code>PVT_...</code> al campo <strong>Project v2 ID</strong>.</div>
    
    <footer>Usa con cuidado. El token se queda en tu navegador.</footer>
  </div>

<script>
/* Helpers */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function append(msg, cls){ const out=document.getElementById('output'); const d=document.createElement('div'); d.className='line'; d.innerHTML = (cls?`<div class="${cls}">${cls.toUpperCase()}</div>`:'') + `<pre>${escapeHtml(msg)}</pre>`; out.prepend(d); }
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/* Toggle repo inputs */
document.getElementById('mode').addEventListener('change', (e)=>{
  document.getElementById('repoRow').style.display = e.target.value === 'create_and_add' ? 'block' : 'none';
});

/* GraphQL helper */
async function graphqlRequest(token, query, variables){
  const res = await fetch('https://api.github.com/graphql', {
    method: 'POST',
    headers: {
      'Content-Type':'application/json',
      'Authorization': 'Bearer ' + token,
      'Accept': 'application/vnd.github+json'
    },
    body: JSON.stringify({query, variables})
  });
  const data = await res.json();
  return data;
}

/* Create draft issue in Project v2 */
async function createDraftIssue(token, projectId, title, body){
  const mutation = `
    mutation($projectId: ID!, $title: String!, $body: String) {
      addProjectV2DraftIssue(input: { projectId: $projectId, title: $title, body: $body }) {
        projectItem { id }
      }
    }`;
  const vars = { projectId, title, body: body || null };
  const resp = await graphqlRequest(token, mutation, vars);
  if (resp.errors) throw new Error(JSON.stringify(resp.errors));
  return resp.data.addProjectV2DraftIssue.projectItem.id;
}

/* Create repo issue via REST and return node_id (contentId) */
async function createRepoIssueREST(token, owner, repo, title, body){
  const url = `https://api.github.com/repos/${owner}/${repo}/issues`;
  const res = await fetch(url, {
    method:'POST',
    headers: {
      'Authorization':'Bearer ' + token,
      'Accept':'application/vnd.github+json',
      'Content-Type':'application/json'
    },
    body: JSON.stringify({ title, body })
  });
  const data = await res.json();
  if (!res.ok) throw new Error(JSON.stringify(data));
  return { node_id: data.node_id, html_url: data.html_url, number: data.number };
}

/* Add existing content (issue) to Project v2 by contentId (node_id) */
async function addItemByContentId(token, projectId, contentId){
  const mutation = `
    mutation($projectId: ID!, $contentId: ID!) {
      addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
        item { id }
      }
    }`;
  const vars = { projectId, contentId };
  const resp = await graphqlRequest(token, mutation, vars);
  if (resp.errors) throw new Error(JSON.stringify(resp.errors));
  return resp.data.addProjectV2ItemById.item.id;
}

/* Parse lines "Title | body" */
function parseLine(line){
  const parts = line.split('|').map(p=>p.trim());
  return { title: parts[0]||'', body: parts[1]||'' };
}

/* Batch create */
async function batchCreateFromArray(arr, opts){
  const { token, projectId, mode, owner, repo } = opts;
  append(`Starting batch: ${arr.length} items. Mode=${mode}`, 'ok');
  for (let i=0;i<arr.length;i++){
    const it = arr[i];
    append(`Processing: ${it.title}`, null);
    try {
      if (mode === 'draft'){
        const itemId = await createDraftIssue(token, projectId, it.title, it.body);
        append(`Draft created • itemId: ${itemId}`, 'ok');
      } else {
        if (!owner||!repo) throw new Error('owner/repo required for this mode');
        const created = await createRepoIssueREST(token, owner, repo, it.title, it.body);
        append(`Repo issue created • #${created.number} • ${created.html_url}`, 'ok');
        const itemId = await addItemByContentId(token, projectId, created.node_id);
        append(`Added to project • itemId: ${itemId}`, 'ok');
      }
    } catch (err){
      append(`Error: ${err.message}`, 'err');
    }
    await sleep(300);
  }
  append('Batch finished.', 'ok');
}

/* Event handlers for create */
document.getElementById('createFromLines').addEventListener('click', async ()=>{
  const token = document.getElementById('token').value.trim();
  const projectId = document.getElementById('projectId').value.trim();
  const mode = document.getElementById('mode').value;
  if (!token || !projectId){ alert('Token y Project ID son obligatorios'); return; }
  const text = document.getElementById('lines').value.trim();
  if (!text){ alert('No hay líneas'); return; }
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  const arr = lines.map(parseLine);
  const owner = document.getElementById('owner').value.trim();
  const repo = document.getElementById('repo').value.trim();
  await batchCreateFromArray(arr, { token, projectId, mode, owner, repo });
});

document.getElementById('createFromJson').addEventListener('click', async ()=>{
  const token = document.getElementById('token').value.trim();
  const projectId = document.getElementById('projectId').value.trim();
  const mode = document.getElementById('mode').value;
  if (!token || !projectId){ alert('Token y Project ID son obligatorios'); return; }
  const jsonText = document.getElementById('jsonInput').value.trim();
  if (!jsonText){ alert('JSON vacío'); return; }
  let arr;
  try { arr = JSON.parse(jsonText); if (!Array.isArray(arr)) throw new Error('Se espera un array'); }
  catch(e){ alert('JSON inválido: ' + e.message); return; }
  const norm = arr.map(it=>({ title: it.title||it.titulo||'Sin título', body: it.body||it.descripcion||'' }));
  const owner = document.getElementById('owner').value.trim();
  const repo = document.getElementById('repo').value.trim();
  await batchCreateFromArray(norm, { token, projectId, mode, owner, repo });
});

document.getElementById('clearOutput').addEventListener('click', ()=>{ document.getElementById('output').innerHTML=''; document.getElementById('projectsContainer').innerHTML=''; });

/* List Projects visually and make them clickable */
document.getElementById('testToken').addEventListener('click', async ()=>{
  const token = document.getElementById('token').value.trim();
  const projectsContainer = document.getElementById('projectsContainer');
  projectsContainer.innerHTML = '';
  if (!token){ alert('Introduce token'); return; }
  append('Consultando Projects...', 'ok');
  try {
    const query = `query { viewer { login projectsV2(first:100){ nodes { id title url number } } } }`;
    const resp = await graphqlRequest(token, query, {});
    if (resp.errors) {
      // show helpful message if it's a common forbidden/SSO error
      const msg = JSON.stringify(resp.errors);
      append('Error al listar Projects: ' + msg, 'err');
      if (msg.includes('Resource not accessible by personal access token')) {
        append('Tu token no está autorizado para ver esos Projects. Si pertenecen a una organización, habilita SSO/autoriza el token para la organización.', 'err');
      }
      return;
    }
    const viewer = resp.data.viewer;
    append(`Usuario: ${viewer.login}`, 'ok');
    const nodes = viewer.projectsV2.nodes || [];
    if (nodes.length === 0) {
      append('No se encontraron Projects v2 accesibles con este token.', null);
      return;
    }
    // render list
    nodes.forEach(p => {
      const div = document.createElement('div');
      div.className = 'project-item';
      const meta = document.createElement('div');
      meta.className = 'project-meta';
      meta.innerHTML = `<strong>${escapeHtml(p.title)}</strong><div class="project-meta-details">url: ${escapeHtml(p.url)} • number: ${escapeHtml(p.number||'')}</div>`;
      const btns = document.createElement('div');
      btns.className = 'project-actions';
      const useBtn = document.createElement('button');
      useBtn.className = 'primary';
      useBtn.textContent = 'Usar';
      useBtn.title = 'Copiar PVT id al campo Project v2 ID';
      useBtn.addEventListener('click', ()=> {
        document.getElementById('projectId').value = p.id;
        append(`Project ID copiado: ${p.id}`, 'ok');
        // highlight selected visually
        Array.from(document.querySelectorAll('.project-item')).forEach(it=>it.style.outline='none');
        div.style.outline = '2px solid var(--accent)';
      });
      const openBtn = document.createElement('button');
      openBtn.className = 'secondary';
      openBtn.textContent = 'Abrir';
      openBtn.title = 'Abrir en GitHub';
      openBtn.addEventListener('click', ()=> window.open(p.url, '_blank'));
      btns.appendChild(useBtn);
      btns.appendChild(openBtn);
      div.appendChild(meta);
      div.appendChild(btns);
      projectsContainer.appendChild(div);
    });
    append(`Se listaron ${nodes.length} projects. Haz clic en "Usar" para copiar el PVT id.`, 'ok');
  } catch (err) {
    append('Error al listar Projects: ' + err.message, 'err');
  }
});
</script>
</body>
</html>